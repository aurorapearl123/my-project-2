<?php
defined('BASEPATH') OR exit('No direct script access allowed');

class Payroll_gnp extends CI_Controller
{
    //Default Variables
    var $common_menu;
    var $roles;
    var $data;
    var $table;
    var $pfield;
    var $logfield;
    var $module;
    var $module_label;
    var $module_path;
    var $controller_page;

    public function __construct()
    {
        parent::__construct();
        $this->load->model('generic_model','record');
        // set variables
        $this->data['current_module'] = $this->module = 'General Payroll';
        $this->module_label = 'General Payroll';
        $this->table        = 'payroll';
        $this->module_path  = 'modules/Payroll/GNP';
        $this->module_path_submenu  = 'modules/Payroll/submenu';
        $this->pfield = 'payrollID';
        $this->logfield = 'payrollNo';
        $this->data['controller_page'] = $this->controller_page = site_url('payroll_gnp');
        // check if under maintenance
        if ($this->config_model->getConfig('Maintenance Mode')=='1') {
            header('location: '.site_url('maintenance_mode'));
        }
        // check if loggedin
    }

    private function submenu()
    {
        //submenu setup
    }
    
    private function check_roles()
    {
        $this->roles['create']  = $this->userrole_model->has_access($this->session->userdata('current_userID'),'Add '.$this->module);
        $this->roles['view']    = $this->userrole_model->has_access($this->session->userdata('current_userID'),'View '.$this->module);
        $this->roles['edit']    = $this->userrole_model->has_access($this->session->userdata('current_userID'),'Edit Existing '.$this->module);
        $this->roles['delete']  = $this->userrole_model->has_access($this->session->userdata('current_userID'),'Delete Existing '.$this->module);
        $this->roles['approve'] = $this->userrole_model->has_access($this->session->userdata('current_userID'),'Approve '.$this->module);
    }
    
    public function index()
    {
        $this->show();
    }
    
    public function create()
    {
        $this->submenu();
        $data = $this->data;
        // check roles
        if ($this->roles['create']) {
            $data['required_fields'] = array('companyID'=>'Company', 'officeID'=>'Office','payrollPeriodID'=>'Payroll Period','attendancePeriodID'=>'Attendance Period','payrollGroupID'=>'Payroll Group');                                                                                             
            // set sessions
            $this->session->set_userdata('current_companyID', $data['companyID']);
            $this->session->set_userdata('current_officeID', $data['officeID']);
            $this->session->set_userdata('current_divisionID', $data['divisionID']);
            $this->session->set_userdata('current_payrollGroupID', $data['payrollGroupID']);
            $this->session->set_userdata('current_payrollPeriodID', $data['payrollPeriodID']);
            $this->session->set_userdata('current_attendancePeriodID', $data['attendancePeriodID']);

            // load views
            $this->load->view('header', $data);
            $this->load->view($this->module_path.'/create');
            $this->load->view('footer');

        } else {
            // no access this page
            $data['class']  = "danger";
            $data['msg']    = "Sorry, you don't have access to this page!";
            $data['urlredicrect']    = "";
            $this->load->view('header', $data);
            $this->load->view('message');
            $this->load->view('footer');
        }
    }
    
    public function save()
    {
        //load submenu
        $this->submenu();
        $data = $this->data;

        // check role
        if ($this->roles['create']) {
            $this->record->table  = $this->table;
            $this->record->fields = array();
            
            $this->record->fields['payrollPeriodID']    = $this->encrypter->decode($this->input->post('payrollPeriodID'));
            $this->record->fields['companyID']          = $this->encrypter->decode($this->input->post('companyID'));
            $this->record->fields['officeID']           = $this->encrypter->decode($this->input->post('officeID'));
            $this->record->fields['divisionID']         = $this->encrypter->decode($this->input->post('divisionID'));
            $this->record->fields['employeeTypeID']     = implode(',',$this->input->post('employeeTypeID'));
            $this->record->fields['payrollGroupID']     = $this->encrypter->decode($this->input->post('payrollGroupID'));
            $this->record->fields['attendancePeriodID'] = $this->encrypter->decode($this->input->post('attendancePeriodID'));
            $this->record->fields['generatedBy']        = $this->session->userdata('current_userID');
            $this->record->fields['dateGenerated']      = date('Y-m-d H:i:s');
            
            // get payroll period info
            $this->db->where('payrollPeriodID', $this->record->fields['payrollPeriodID']);
            $payrollPeriod = $this->db->get('payroll_periods', 1)->row();
            
            // attendance
            $this->db->where('payrollPeriodID', $this->record->fields['attendancePeriodID']);
            $attendancePeriod = $this->db->get('payroll_periods', 1)->row();
            
            $start    = strtotime($attendancePeriod->startDate);
            $end      = strtotime($attendancePeriod->endDate);
            
            $this->record->fields['payrollNo']          = $genNo = $this->_generateID(date('ym', strtotime($payrollPeriod->startDate)));

            if ($this->record->save()) {
                $this->record->fields = array();
                $this->record->where['payrollNo']   = $genNo;
                $this->record->retrieve();
            
                $this->frameworkhelper->increment_series('General Payroll Series');
                
                if ($payrollPeriod->type == 'SM') {
                    $firstHalf = (date('d',strtotime($payrollPeriod->startDate) == '01')) ? true : false;
                }
                
                // get attendance dates
                $this->db->where('payrollPeriodID', $this->record->field->payrollPeriodID);
                $attendance_dates = $this->db->get('payroll_details');
                $days = $attendance_dates->num_rows();
                
                $employmentIDs      = $this->input->post('chkAdd');
                
                // load employees
                $this->db->select('employments.*');
                $this->db->select('employees.taxID');
                $this->db->select('employee_types.workingDays');
                $this->db->select('employee_types.employeeType');
                $this->db->select('employee_types.withPay');
                $this->db->select('tax_withholding.payID');
                $this->db->select('tax_withholding.amount as wtax');
                $this->db->select('tax_withholding.isAutomatic');
                $this->db->select('tax_exemptions.personalExemption');
                $this->db->select('tax_exemptions.additionalExemption');
                $this->db->from('employments');
                $this->db->join('employees', 'employments.empID=employees.empID', 'left');
                $this->db->join('employee_types','employments.employeeTypeID=employee_types.employeeTypeID', 'left');
                $this->db->join('job_positions','employments.jobPositionID=job_positions.jobPositionID', 'left');
                $this->db->join('job_titles','job_positions.jobTitleID=job_titles.jobTitleID', 'left');
                $this->db->join('tax_withholding','employments.employmentID=tax_withholding.employmentID','left');
                $this->db->join('tax_exemptions','employees.taxID=tax_exemptions.taxID','left');
                $this->db->where_in('employments.employmentID', $employmentIDs);
                $this->db->order_by('employments.lname','asc');
                $this->db->order_by('employees.fname','asc');
                $this->db->order_by('employments.mname','asc');
                $records = $this->db->get();
                
                $incentive_batch    = array();
                $premium_batch      = array();
                $loan_batch         = array();
                if ($records->num_rows()) {
                    foreach ($records->result() as $row) {                                              
                        $hoursRequired  = 0;
                        $hoursUndertime = 0;
                        $hoursRendered  = 0;
                        $daysRequired   = 0;
                        $daysUndertime  = 0;
                        $daysRendered   = 0;
                        $leavesWP       = 0;
                        $leavesWOP      = 0;
                        $lateToLeave    = 0;
                        $wop            = 0;
                        $totalIncentive = 0;
                        $totalGross     = 0;
                        $totalDeduction = 0;
                        $netPay         = 0;
                        
                        
                        $tardyMin       = 0;
                        $tardyCount     = 0;
                        $utCount        = 0;
                        $utMin          = 0;
                        $absentCount    = 0;
                        
                        // -------- calculate attendance --------------------------------------------
                        for ($current = $start; $current <= $end; $current = strtotime('+1 day', $current)) {
                            $dtr = $this->dtrlog->analyze($row->employmentID, $current);
                             
                            if (!empty ($dtr)) {
                                foreach ($dtr as $log) {
                                    if ($log['schedule'] == '1') {
                                        $daysRequired++;
                                    }
                                    
                                    // tardiness
                                    if (strlen($log['tardy_date']) > 5) {
                                        $tardyCount  += 2;
                                    } elseif (intval($log['tardy']) > 0) {
                                        $tardyCount  += 1;
                                    }
                                    $tardyMin += intval($log['tardy']);
                                     
                                    // undertime
                                    if (strlen($log['ut_date']) > 5) {
                                        $utCount  += 2;
                                    } elseif (intval($log['ut_date']) > 0) {
                                        $utCount  += 1;
                                    }
                                    $utMin += intval($log['undertime']);
                                     
                                    // absences
                                    $absentCount += ($log['remarks'] == 'ABSENT') ? 1 : 0;
                                     
                                    // leaves, orders, suspension
                                    //                          $res[$info['los']]   += ($info['los']) ? $info['los_day'] : 0;
                                     
                                }
                            }
                        }
                        
                        $ut = $tardyMin + $utMin;
                        
                        // number of days without pay
                        $daysRequired   = $daysRequired;
                        $daysUndertime  = $absentCount;
                        $daysUndertime += $ut / 480;
                        $daysRendered   = $daysRequired - $daysUndertime;
                        
                        
                        // calculate withoutpay
                        if ($daysUndertime > 0) {
                            // get daily rate
                            $dailyRate    = $row->basicSalary / $row->workingDays;
                            $wop          = round($dailyRate * $daysUndertime, 2);
                        }
                        // ----------------------------------------------------------------------
                        
                        $totalDeduction   = $wop;
                            
                        // -------- calculate salary --------------------------------------------
                        $monthlySalary = round($row->basicSalary - round($wop, 3), 2);
                        if ($payrollPeriod->type == 'MO') {
                            $salary = round($row->basicSalary, 2);
                            //$salary   = round($row->basicSalary - $wop, 2);
                        } else {
                            $salary = ($firstHalf) ? $this->fnumber_format(($row->basicSalary) / 2, '.') : round(($row->basicSalary) / 2, 2, PHP_ROUND_HALF_UP);
                            //$salary   = ($firstHalf) ? $this->fnumber_format(($row->basicSalary - $wop) / 2, '.') : round(($row->basicSalary - $wop) / 2, 2, PHP_ROUND_HALF_UP);
                        }
                        
                        
                        // ----------------------------------------------------------------------
                        
                        // -------- save initial payslip ----------------------------------------
                        $this->db->set('payrollID', $this->record->field->payrollID);
                        $this->db->set('empID', $row->empID);
                        $this->db->set('employmentID', $row->employmentID);
                        $this->db->set('employeeTypeID', $row->employeeTypeID);
                        $this->db->set('jobTitleID', $row->jobTitleID);
                        $this->db->set('hoursRequired', $hoursRequired);
                        $this->db->set('hoursUndertime', $hoursUndertime);
                        $this->db->set('hoursRendered', $hoursRendered);
                        $this->db->set('daysRequired', $daysRequired);
                        $this->db->set('daysUndertime', $daysUndertime);
                        $this->db->set('daysRendered', $daysRendered);
                        $this->db->set('leavesWP', $leavesWP);
                        $this->db->set('leavesWOP', $leavesWOP);
                        $this->db->set('basicRate', $salary);
                        $this->db->set('wop', $wop);
                        $this->db->insert('payslips');
                        // ----------------------------------------------------------------------
                        
                        $payslipID = $this->db->insert_id();
                        
                        // calculate incentives
                        $result = $this->payrollcalc->incentive($row->employmentID, $payrollPeriod, $payslipID);
                        $totalIncentive  = $result['totalIncentive'];   
                        $incentive_batch = $result['incentives'];                                                                                                                       
                            
                        // calculate grosspay
                        $grossPay = $salary + $totalIncentive;
                                                                                
                        // calculate wtax
                        if ($row->payID) {
                            if ($row->isAutomatic) {
                                $result = $this->payrollcalc->wtax($row->employmentID, $row->taxID, $row->basicSalary, $payrollPeriod);
                                $wtax = $result['amount'];
                            } else {
                                $wtax = $row->wtax;
                            }
                            
                            
                            $info = array();
                            $info['payslipID']      = $payslipID;
                            $info['payID']          = $row->payID;
                            $info['type']           = 1;
                            $info['deductionID']    = 0;
                            if ($payrollPeriod->type == 'SM') {
                                $info['amount']  = ($firstHalf) ? $this->fnumber_format($wtax / 2, '.') : round($wtax / 2, 2, PHP_ROUND_HALF_UP);
                            } else {
                                $info['amount']  = round($wtax, 2, PHP_ROUND_HALF_UP);
                            }
                            $loan_batch[] = $info;
                            
                            $totalDeduction += $info['amount'];
                        }
                        
                        // calculate contributions
                        $result = $this->payrollcalc->contribution($row->employmentID, $row->basicSalary, $payrollPeriod, $payslipID);                      
                        $premium_batch  = $result['contributions'];
                        $totalDeduction    += $result['totalEmployeeShare'];
                        
                        // calculate loans
                        $result = $this->payrollcalc->loan($row->employmentID, $row->basicSalary, $payrollPeriod, $payslipID);
                        if (!empty($result['loans'])) {
                            foreach ($result['loans'] as $loan) {
                                $loan_batch[] = $loan;
                            }
                        }           
                        $totalDeduction    += $result['totalDeduction'];
                            
                        // calculate net pay
                        $netPay = $grossPay - $totalDeduction;
                        
                        // update payslip
                        $this->db->set('wop', $wop);
                        $this->db->set('totalIncentive', $totalIncentive);
                        $this->db->set('totalGross', $grossPay);
                        $this->db->set('totalDeduction', $totalDeduction);
                        $this->db->set('netPay', $netPay);
                        $this->db->where('payslipID', $payslipID);
                        $this->db->update('payslips');
                        
                        if (!empty($incentive_batch)) {
                            $this->db->insert_batch('payslip_incentives', $incentive_batch);
                        }
                            
                        if (!empty($premium_batch)) {
                            $this->db->insert_batch('payslip_contributions', $premium_batch);
                        }
                            
                        if (!empty($loan_batch)) {
                            $this->db->insert_batch('payslip_deductions', $loan_batch);
                        }
                    }
                    
                    
                }
                
                $this->session->set_userdata('current_companyID', $this->record->field->companyID);
                $this->session->set_userdata('current_officeID', $this->record->field->officeID);
                $this->session->set_userdata('current_divisionID', $this->record->field->divisionID);
                $this->session->set_userdata('current_payrollPeriodID', $this->record->field->payrollPeriodID);
                $this->session->set_userdata('current_attendancePeriodID', $this->record->field->attendancePeriodID);
                $this->session->set_userdata('current_payrollGroupID', $this->record->field->payrollGroupID);
                
                // record logs
                $logs = "Record - ".$genNo;
                $this->log_model->table_logs($this->module, $this->table, $this->pfield, $this->record->field->$data['pfield'], 'Insert', $logs);
                
                $logfield = $this->pfield;

                // success msg
                $data['class']  = "success";
                $data['msg']    = $this->module." successfully saved.";
                $data['urlredicrect']    = "";
                $this->load->view('header', $data);
                $this->load->view('message');
                $this->load->view('footer');
            } else {
                // Unable to save
                $data['class']  = "danger";
                $data['msg']    = "Error in saving the ".strtolower($this->module)."!";
                $data['urlredicrect']    = "";
                $this->load->view('header', $data);
                $this->load->view('message');
                $this->load->view('footer');
            }

        } else {
            // no access this page
            $data['class']  = "danger";
            $data['msg']    = "Sorry, you don't have access to this page!";
            $data['urlredicrect']    = "";
            $this->load->view('header', $data);
            $this->load->view('message');
            $this->load->view('footer');
        }
    }
    
    public function edit($id)
    {
        $this->submenu();
        $data = $this->data;
        $id = $this->encrypter->decode($id);

        if ($this->roles['edit']) {
            $data['required_fields'] = array('countryID'=>'Country', 'province'=>'Province', 'status'=>'Status');               
            // for retrieve with joining tables -------------------------------------------------
            // set table
            $this->record->table = $this->table;
            // set fields for the current table
            $this->record->setFields();
            // extend fields - join tables                  
            // set joins                
            // set where
            $this->record->where[$this->table.'.'.$this->pfield] = $id;
            // execute retrieve
            $this->record->retrieve();
            // ----------------------------------------------------------------------------------
            $data['rec'] = $this->record->field;

            // load views
            $this->load->view('header', $data);
            $this->load->view($this->module_path.'/edit');
            $this->load->view('footer');
        } else {
            // no access this page
            $data['class']  = "danger";
            $data['msg']    = "Sorry, you don't have access to this page!";
            $data['urlredicrect']    = "";
            $this->load->view('header', $data);
            $this->load->view('message');
            $this->load->view('footer');
        }
    }
    
    public function update()
    {
        // load submenu
        $this->submenu();
        $data = $this->data;
        $table_fields = array('countryID', 'province', 'remarks', 'status');

        if ($this->roles['edit']) {
            $this->record->table  = $this->table;
            $this->record->fields = array();
            
            foreach($table_fields as $fld) {
                $this->record->fields[$fld] = trim($this->input->post($fld));
            }               

            $this->record->pfield   = $this->pfield;
            $this->record->pk       = trim($this->input->post($this->pfield));
            
            // field logs here
            $wasChange = $this->log_model->field_logs($this->module, $this->table, $this->pfield, $this->record->pk, 'Update', $this->record->fields);

            if ($this->record->update()) {
                // record logs
                if ($wasChange) {
                    $logs = "Record - ".trim($this->input->post($this->logfield));
                    $this->log_model->table_logs($this->module, $this->table, $this->pfield, $this->record->pk, 'Update', $logs);
                }

                // Successfully updated
                $data['class']  = "success";
                $data['msg']    = $this->module." successfully updated.";
                $data['urlredicrect']    = "";
                $this->load->view('header', $data);
                $this->load->view('message');
                $this->load->view('footer');
            } else {
                // Error updating
                $data['class']  = "danger";
                $data['msg']    = "Error in updating the ".strtolower($this->module)."!";
                $data['urlredicrect']    = "";
                $this->load->view('header', $data);
                $this->load->view('message');
                $this->load->view('footer');
            }
        } else {
            // no access this page
            $data['class']  = "danger";
            $data['msg']    = "Sorry, you don't have access to this page!";
            $data['urlredicrect']    = "";
            $this->load->view('header', $data);
            $this->load->view('message');
            $this->load->view('footer');
        }
    }

    public function delete($id=0)
    {
        // load submenu
        $this->submenu();
        $data = $this->data;
        $id = $this->encrypter->decode($id);

        if ($this->roles['delete'] && !$this->_in_used($id)) {
            // set fields
            $this->record->fields = array();
            // set table
            $this->record->table  = $this->table;
            // set where
            $this->record->where[$this->pfield] = $id;
            // execute retrieve
            $this->record->retrieve();

            if (!empty($this->record->field)) {
                $this->record->pfield   = $this->pfield;
                $this->record->pk       = $id;
                
                // record logs
                $logfield = $this->logfield;

                if ($this->record->delete()) {
                    $this->db->where('payrollID', $id);
                    $payslips = $this->db->get('payslips')->result();
                    
                    foreach ($payslips as $payslip) {
                        $this->db->where('payslipID', $payslip->payslipID);
                        $this->db->delete('payslip_contributions');
    
                        $this->db->where('payslipID', $payslip->payslipID);
                        $this->db->delete('payslip_deductions');
    
                        $this->db->where('payslipID', $payslip->payslipID);
                        $this->db->delete('payslip_incentives');                        
                    }
                    
                    $this->db->where('payrollID', $id);
                    $this->db->delete('payslips');
                    
                    // record logs
                    $logs = "Record - ".$this->record->field->$logfield;
                    $this->log_model->table_logs($this->module, $this->table, $this->pfield, $this->record->pk, 'Delete', $logs);

                    //Success msg
                    $data['class']  = "success";
                    $data['msg']    = $this->module." successfully deleted.";
                    $data['urlredicrect']    = $this->controller_page."/show";
                    $this->load->view('header', $data);
                    $this->load->view('message');
                    $this->load->view('footer');
                } else {
                    //Error Deleting
                    $data['class']  = "danger";
                    $data['msg']    = "Error in deleting the ".strtolower($this->module)."!";
                    $data['urlredicrect']    = "";
                    $this->load->view('header', $data);
                    $this->load->view('message');
                    $this->load->view('footer');
                }

            } else {
                //Record not found
                $data['class']  = "danger";
                $data['msg']    = $this->module." record not found!";
                $data['urlredicrect']    = "";
                $this->load->view('header', $data);
                $this->load->view('message');
                $this->load->view('footer');
            }
        } else {
            //No access this page
            $data['class']  = "danger";
            $data['msg']    = "Sorry, you don't have access to this page!";
            $data['urlredicrect']    = "";
            $this->load->view('header', $data);
            $this->load->view('message');
            $this->load->view('footer');
        }
    }
    
    public function view($id)
    {
        // load submenu
        $this->submenu();
        $data = $this->data;
        $id = $this->encrypter->decode($id);

        if ($this->roles['view']) {
            // for retrieve with joining tables -------------------------------------------------
            // set table
            $this->record->table = $this->table;
            // set fields for the current table
            $this->record->setFields();
            // extend fields - join tables      
            $this->record->fields[] = 'payroll_periods.payrollPeriod';
            $this->record->fields[] = 'attendance_periods.payrollPeriod as attendancePeriod';
            $this->record->fields[] = 'payroll_periods.type';
            $this->record->fields[] = 'companies.companyName';
            $this->record->fields[] = 'offices.officeName';
            $this->record->fields[] = 'divisions.divisionName'; 
            $this->record->fields[] = 'payroll_groups.payrollGroup';
                        
            // set joins
            $this->record->joins[]  = array('payroll_periods',$this->table.'.payrollPeriodID=payroll_periods.payrollPeriodID','left');
            $this->record->joins[]  = array('payroll_periods attendance_periods',$this->table.'.attendancePeriodID=attendance_periods.payrollPeriodID','left');
            $this->record->joins[]  = array('companies',$this->table.'.companyID=companies.companyID','left');
            $this->record->joins[]  = array('offices',$this->table.'.officeID=offices.officeID','left');
            $this->record->joins[]  = array('divisions',$this->table.'.divisionID=divisions.divisionID','left');                
            $this->record->joins[]  = array('payroll_groups',$this->table.'.payrollGroupID=payroll_groups.payrollGroupID','left');
            // set where
            $this->record->where[$this->table.'.'.$this->pfield] = $id;
            
            // execute retrieve
            $this->record->retrieve();
            // ----------------------------------------------------------------------------------
            $data['rec'] = $this->record->field;
            
            $this->db->select('payslips.*');
            $this->db->select('employees.fname');
            $this->db->select('employees.suffix');
            $this->db->select('employments.lname');
            $this->db->select('employments.mname');
            $this->db->select('employments.employmentNo');                      
            $this->db->select('employee_types.employeeType');
            $this->db->from('payslips');
            $this->db->join('employees','payslips.empID=employees.empID','left');
            $this->db->join('employments','payslips.employmentID=employments.employmentID','left');
            $this->db->join('employee_types','payslips.employeeTypeID=employee_types.employeeTypeID','left');
            $this->db->where('payslips.payrollID', $id);
            $data['payslips'] = $this->db->get();
            
            // record logs
            if ($this->config_model->getConfig('Log all record views') == '1') {
                $logfield = $this->logfield;
                $logs = "Record - ".$this->record->field->$logfield;
                $this->log_model->table_logs($this->module, $this->table, $this->pfield, $this->record->field->$data['pfield'], 'View', $logs);
            }
            
            // check if record is used in other tables
            $data['inUsed'] = false;
            //load views
            $this->load->view('header', $data);
            $this->load->view($this->module_path.'/view');
            $this->load->view('footer');
        } else {
            // no access this page
            $data['class']  = "danger";
            $data['msg']    = "Sorry, you don't have access to this page!";
            $data['urlredicrect']    = "";
            $this->load->view('header', $data);
            $this->load->view('message');
            $this->load->view('footer');
        }
    }
    
    public function show()
    {
        // load submenu
        $this->submenu();
        $data = $this->data;
        // Sorting Functions

        //Setup list
        $data['records'] = $this->db->get($this->table);
        //load views
        $this->load->view('header', $data);
        $this->load->view($this->module_path.'/list');
        $this->load->view('footer');
    }
    
    public function printlist()
    {
        // load submenu
        $this->submenu();
        $data = $this->data;
        //sorting

        //load views
        $this->load->view('header', $data);
        $this->load->view($this->module_path.'/printlist');
        $this->load->view('footer');
    }
    
    //Conditions and fields changes
    public function check_duplicate()
    {
        // set table
        $this->record->table = $this->table;
        // set where        
        $this->record->where['payrollPeriodID'] = $this->encrypter->decode($this->input->post('payrollPeriodID'));
        $this->record->where['companyID']       = $this->encrypter->decode($this->input->post('companyID'));
        $this->record->where['officeID']        = $this->encrypter->decode($this->input->post('officeID'));
        $this->record->where['divisionID']      = $this->encrypter->decode($this->input->post('divisionID'));
        $this->record->where['employeeTypeID']  = str_replace('_',',',$this->input->post('employeeTypeID'));
        $this->record->where['payrollGroupID']  = $this->encrypter->decode($this->input->post('payrollGroupID'));
        // execute retrieve
        $this->record->retrieve();
        
        if (!empty($this->record->field))
            echo "1"; // duplicate
        else 
            echo "0";
    }










    //Ajax functions
    public function setEmployeesEncrypt($companyID=0, $officeID=0, $divisionID=0, $payrollGroupID=0, $payrollPeriodID=0, $attendancePeriodID=0, $employeeTypeID=0)
    {
        $data['companyID']          = $this->encrypter->decode($companyID);
        $data['officeID']           = $this->encrypter->decode($officeID);
        $data['divisionID']         = $this->encrypter->decode($divisionID);
        $data['payrollGroupID']     = $this->encrypter->decode($payrollGroupID);
        $data['payrollPeriodID']    = $this->encrypter->decode($payrollPeriodID);
        $data['attendancePeriodID'] = $this->encrypter->decode($attendancePeriodID);
        $data['employeeTypeID']     = explode('_', $employeeTypeID);
        
        // get payroll period
        $this->db->where('payrollPeriodID', $data['payrollPeriodID']);
        $payrollPeriod = $this->db->get('payroll_periods', 1)->row();
        
        // attendance
        $this->db->where('payrollPeriodID', $data['attendancePeriodID']);
        $attendancePeriod = $this->db->get('payroll_periods', 1)->row();
        
        $start    = strtotime($attendancePeriod->startDate);
        $end      = strtotime($attendancePeriod->endDate);
        
        if ($payrollPeriod->type == 'SM') {
            $firstHalf = (date('d',strtotime($payrollPeriod->startDate) == '01')) ? true : false;
        }
    
        // select
        $this->db->select('employments.*');
        $this->db->select('employees.empNo');
        $this->db->select('employees.fname');
        $this->db->select('employees.suffix');
        $this->db->select('employees.taxID');
        $this->db->select('job_positions.positionCode');
        $this->db->select('job_titles.jobTitle');
        $this->db->select('employee_types.workingDays');
        $this->db->select('employee_types.employeeType');
        $this->db->select('employee_types.withPay');
        $this->db->select('tax_withholding.amount as wtax');
        $this->db->select('tax_withholding.isAutomatic');
        $this->db->select('tax_exemptions.personalExemption');
        $this->db->select('tax_exemptions.additionalExemption');        
        $this->db->from('employments');
        $this->db->join('employees', 'employments.empID=employees.empID', 'left');      
        $this->db->join('employee_types','employments.employeeTypeID=employee_types.employeeTypeID', 'left');
        $this->db->join('job_positions','employments.jobPositionID=job_positions.jobPositionID', 'left');
        $this->db->join('job_titles','job_positions.jobTitleID=job_titles.jobTitleID', 'left');
        $this->db->join('tax_withholding','employments.employmentID=tax_withholding.employmentID','left');
        $this->db->join('tax_exemptions','employees.taxID=tax_exemptions.taxID','left');
        if ($data['companyID']) {
            $this->db->where('employments.companyID', $data['companyID']);
        }
        if ($data['officeID']) {
            $this->db->where('employments.officeID', $data['officeID']);
        }
        if ($data['divisionID']) {
            $this->db->where('employments.divisionID', $data['divisionID']);
        }
        $this->db->where_in('employments.employeeTypeID', $data['employeeTypeID']);
        $this->db->where('employments.payrollGroupID', $data['payrollGroupID']);
        $this->db->where('employments.dateAppointed <=', $payrollPeriod->endDate);
        $this->db->where('employments.status', 1);
        $this->db->order_by('employments.lname','asc');
        $this->db->order_by('employees.fname','asc');
        $this->db->order_by('employments.mname','asc');
        $records = $this->db->get();
        
        $data['records'] = array();
        if ($records->num_rows()) {
            foreach ($records->result() as $row) {
                $info = array();
                $info['employmentID'] = $row->employmentID;
                $info['employmentNo'] = $row->employmentNo;
                $info['name']         = $row->lname.', '.$row->fname.' '.$row->mname.' '.$row->suffix;
                $info['employeeType'] = $row->employeeType;
                $info['jobTitle']     = $row->jobTitle;                         
                $info['wop']= 0;
                
                $tardyMin       = 0;
                $tardyCount     = 0;
                $utCount        = 0;
                $utMin          = 0;
                $absentCount    = 0;
                
                // analyze attendance
                for ($current = $start; $current <= $end; $current = strtotime('+1 day', $current)) {
                    $dtr = $this->dtrlog->analyze($row->employmentID, $current);
                        
                    if (!empty ($dtr)) {
                        foreach ($dtr as $log) {
                            // tardiness
                            if (strlen($log['tardy_date']) > 5) {
                                $tardyCount  += 2;
                            } elseif (intval($log['tardy']) > 0) {
                                $tardyCount  += 1;
                            }
                            $tardyMin += intval($log['tardy']);
                                
                            // undertime
                            if (strlen($log['ut_date']) > 5) {
                                $utCount  += 2;
                            } elseif (intval($log['ut_date']) > 0) {
                                $utCount  += 1;
                            }
                            $utMin += intval($log['undertime']);
                                
                            // absences
                            $absentCount += ($log['remarks'] == 'ABSENT') ? 1 : 0;
                                
                            // leaves, orders, suspension
//                          $res[$info['los']]   += ($info['los']) ? $info['los_day'] : 0;
                                
                        }
                    }
                }
                $ut = $tardyMin + $utMin;
                // number of days without pay
                $info['daysRequired']   = $row->workingDays;
                $info['daysUndertime']  = $absentCount;
                $info['daysUndertime'] += $ut / 480;
                $info['daysRendered']   = $info['daysRequired'] - $info['daysUndertime'];
                
                $row->workingDays       = ($row->workingDays) ? $row->workingDays : date('t', strtotime($payrollPeriod->startDate));
                
                // calculate withoutpay
                if ($info['daysUndertime'] > 0) {
                    // get daily rate
                    $dailyRate      = $row->basicSalary / $row->workingDays;
                    $info['wop']    = round($dailyRate * $info['daysUndertime'], 2);
                }
                
                $monthlySalary = round($row->basicSalary - $info['wop'], 2); 
                if ($payrollPeriod->type == 'MO') { 
                    $info['basicSalary'] = round($row->basicSalary, 2);
                    $salary = round($info['basicSalary'] - $info['wop'], 2);
                } else {
                    $info['basicSalary'] = ($firstHalf) ? $this->fnumber_format($row->basicSalary / 2, '.') : round($row->basicSalary / 2, 2, PHP_ROUND_HALF_UP);
                    $salary = ($firstHalf) ? $this->fnumber_format(($info['basicSalary'] - $info['wop']) / 2, '.') : round(($info['basicSalary'] - $info['wop']) / 2, 2, PHP_ROUND_HALF_UP);
                }           
                
                // calculate incentives
                $result = $this->payrollcalc->incentive($row->employmentID, $payrollPeriod);                
                $info['totalIncentive'] = $result['totalIncentive'];                                                    
                
                // calculate gross pay
                $info['grossPay'] = $info['basicSalary'] + $info['totalIncentive'];             
                
                // calculate wtax
                if ($row->isAutomatic) {
                    $result = $this->payrollcalc->wtax($row->employmentID, $row->taxID, $row->basicSalary, $payrollPeriod);
                    $wtax = $result['amount'];
                } else {
                    $wtax = $row->wtax;
                }
            
                if ($payrollPeriod->type == 'SM') {
                    $wtax  = ($firstHalf) ? $this->fnumber_format($wtax / 2, '.') : round($wtax / 2, 2, PHP_ROUND_HALF_UP);
                } else {
                    $wtax = round($wtax, 2, PHP_ROUND_HALF_UP);
                }
            
                $info['wtax'] = $wtax;

                // calculate contributions
                $result = $this->payrollcalc->contribution($row->employmentID, $row->basicSalary, $payrollPeriod);
                $info['deductions'] = $result['totalEmployeeShare'];
                $info['erShare']    = $result['totalEmployerShare'];

                // calculate loans
                $result = $this->payrollcalc->loan($row->employmentID, $row->basicSalary, $payrollPeriod);
                $info['deductions'] += $result['totalDeduction'];
                // ----------------------------------------------------------------------
                
                $info['netPay']     = $info['grossPay'] - $info['wop'] - $info['wtax'] - $info['deductions'];           
                $data['records'][]  = $info;
            }
        }
    
        // load views
        echo $this->load->view($this->module_path.'/set_employees', $data, true);
    }

    public function display_session()
    {               
        echo var_dump($_SESSION);
    }
    
    function fnumber_format($number,$decimal = '.',$place = '2')
    {
        $broken_number = explode($decimal,$number);
    
        if(empty($broken_number[1])) {
            return $broken_number[0];
        } else {
            return $broken_number[0].$decimal.substr($broken_number[1], 0,2);
        }
    }











    //More pages
    public function print_sheet($payrollID = 0)
    {
        //************** general settings *******************
        // load submenu
        $this->submenu();
        $data = $this->data;
    
        $payrollID          = $this->encrypter->decode($payrollID);
        $data['title']      = "General Payroll";
        // **************************************************
    
        // check roles
        if ($this->roles['view']) {
            // for retrieve with joining tables -------------------------------------------------
            // set table
            $this->record->table = $this->table;
            // set fields for the current table
            $this->record->setFields();
            // extend fields - join tables      
            $this->record->fields[] = 'payroll_periods.payrollPeriod';
            $this->record->fields[] = 'attendance_periods.payrollPeriod as attendancePeriod';
            $this->record->fields[] = 'payroll_periods.type';
            $this->record->fields[] = 'companies.companyName';
            $this->record->fields[] = 'offices.officeName';
            $this->record->fields[] = 'divisions.divisionName'; 
            $this->record->fields[] = 'payroll_groups.payrollGroup';
                        
            // set joins
            $this->record->joins[]  = array('payroll_periods',$this->table.'.payrollPeriodID=payroll_periods.payrollPeriodID','left');
            $this->record->joins[]  = array('payroll_periods attendance_periods',$this->table.'.attendancePeriodID=attendance_periods.payrollPeriodID','left');
            $this->record->joins[]  = array('companies',$this->table.'.companyID=companies.companyID','left');
            $this->record->joins[]  = array('offices',$this->table.'.officeID=offices.officeID','left');
            $this->record->joins[]  = array('divisions',$this->table.'.divisionID=divisions.divisionID','left');                
            $this->record->joins[]  = array('payroll_groups',$this->table.'.payrollGroupID=payroll_groups.payrollGroupID','left');
            // set where
            $this->record->where[$this->table.'.'.$this->pfield] = $payrollID;
            
            // execute retrieve
            $this->record->retrieve();
            // ----------------------------------------------------------------------------------
            $data['rec'] = $this->record->field;
            
            $this->db->select('incentive_types.*');
            $this->db->from('payslip_incentives');
            $this->db->join('payslips','payslip_incentives.payslipID=payslips.payslipID','left');
            $this->db->join('payroll','payslips.payrollID=payroll.payrollID','left');
            $this->db->join('incentive_types','payslip_incentives.incentiveTypeID=incentive_types.incentiveTypeID','left');
            $this->db->where('payslips.payrollID', $payrollID);
            $this->db->group_by('payslip_incentives.incentiveTypeID');
            $data['incentives'] = $this->db->get();
                
            $this->db->select('premiums.*');
            $this->db->from('payslip_contributions');
            $this->db->join('payslips','payslip_contributions.payslipID=payslips.payslipID','left');
            $this->db->join('payroll','payslips.payrollID=payroll.payrollID','left');
            $this->db->join('premiums','payslip_contributions.premiumID=premiums.premiumID','left');
            $this->db->where('payslips.payrollID', $payrollID);
            $this->db->where('payslip_contributions.employeeShare >', 0);
            $this->db->group_by('payslip_contributions.premiumID');
            $data['contributions'] = $this->db->get();
                
            $this->db->select('premiums.*');
            $this->db->from('payslip_contributions');
            $this->db->join('payslips','payslip_contributions.payslipID=payslips.payslipID','left');
            $this->db->join('payroll','payslips.payrollID=payroll.payrollID','left');
            $this->db->join('premiums','payslip_contributions.premiumID=premiums.premiumID','left');
            $this->db->where('payslips.payrollID', $payrollID);
            $this->db->where('payslip_contributions.employerShare >', 0);
            $this->db->group_by('payslip_contributions.premiumID');
            $data['erShares'] = $this->db->get();
                
            $this->db->select('loan_types.*');
            $this->db->from('payslip_deductions');
            $this->db->join('payslips','payslip_deductions.payslipID=payslips.payslipID','left');
            $this->db->join('payroll','payslips.payrollID=payroll.payrollID','left');
            $this->db->join('loan_types','payslip_deductions.deductionID=loan_types.loanTypeID','left');
            $this->db->where('payslips.payrollID', $payrollID);
            $this->db->where('payslip_deductions.type !=', 1);
            $this->db->group_by('payslip_deductions.deductionID');
            $data['deductions'] = $this->db->get();
            
            if ($this->record->field->officeID == 0) {
                $this->db->where('companyID', $this->record->field->companyID);
                $this->db->order_by('rank', 'asc');
                $data['groups'] = $this->db->get('offices')->result();
                
                $data['groupID']    = 'officeID';
                $data['group_label'] = 'officeName';
            } elseif ($this->record->field->divisionID == 0) {
                $this->db->where('officeID', $this->record->field->officeID);
                $this->db->order_by('rank', 'asc');
                $data['groups'] = $this->db->get('divisions')->result();
                
                $data['groupID']    = 'divisionID';
                $data['group_label'] = 'divisionName';
            }
            
            $data['records'] = array();
            foreach ($data['groups'] as $group) {
                $this->db->select('payslips.*');
                $this->db->select('employees.fname');
                $this->db->select('employees.suffix');
                $this->db->select('employments.lname');
                $this->db->select('employments.mname');
                $this->db->select('employments.employmentNo');                      
                $this->db->select('employee_types.employeeType');
                $this->db->from('payslips');
                $this->db->join('employees','payslips.empID=employees.empID','left');
                $this->db->join('employments','payslips.employmentID=employments.employmentID','left');
                $this->db->join('employee_types','payslips.employeeTypeID=employee_types.employeeTypeID','left');
                $this->db->where('payslips.payrollID', $payrollID);
                $this->db->where('employments.'.$data['groupID'], $group->$data['groupID']);
                $payslips = $this->db->get();
                
                if ($payslips->num_rows()) {
                    foreach ($payslips->result() as $payslip) {
                        $info = array();
                        $info['employmentNo'] = $payslip->employmentNo;
                        $info['employee']     = strtoupper($payslip->lname.', '.$payslip->fname.' '.$payslip->mname.' '.$payslip->suffix);
                        $info['basicRate']    = $payslip->basicRate;
                        
                        // incentives
                        if ($data['incentives']->num_rows()) {
                            foreach ($data['incentives']->result() as $incentive) {
                                $this->db->where('payslipID', $payslip->payslipID);
                                $this->db->where('incentiveTypeID', $incentive->incentiveTypeID);
                                $amount = $this->db->get('payslip_incentives')->row()->amount;
                                
                                $info[$incentive->abbr] =  (!empty($amount)) ? $amount : 0;
                            }
                        }
                        
                        $info['totalGross']    = $payslip->totalGross;   // gross (basic rate + incentives)
                        $info['wop']           = $payslip->wop;          // without pay
                        
                        // withholding tax
                        $this->db->where('payslipID', $payslip->payslipID);
                        $this->db->where('type', 1);
                        $amount = $this->db->get('payslip_deductions')->row()->amount;
                        
                        $info['wtax'] =  (!empty($amount)) ? $amount : 0;
                        
                        // contributions
                        if ($data['contributions']->num_rows()) {
                            foreach ($data['contributions']->result() as $contribution) {
                                $this->db->where('payslipID', $payslip->payslipID);
                                $this->db->where('premiumID', $contribution->premiumID);
                                $employeeShare = $this->db->get('payslip_contributions')->row()->employeeShare;
                                 
                                $info[$contribution->abbr] =  (!empty($employeeShare)) ? $employeeShare : 0;
                            }
                        }
                        
                        // contributions
                        if ($data['deductions']->num_rows()) {
                            foreach ($data['deductions']->result() as $deduction) {
                                $this->db->where('payslipID', $payslip->payslipID);
                                $this->db->where('deductionID', $deduction->loanTypeID);
                                $amount = $this->db->get('payslip_deductions')->row()->amount;
                        
                                $info[$deduction->abbr] =  (!empty($amount)) ? $amount : 0;
                            }
                        }
                        
                        $info['netPay']    = $payslip->netPay; // net pay
                        
                        // employer shares
                        if ($data['erShares']->num_rows()) {
                            foreach ($data['erShares']->result() as $erShares) {
                                $this->db->where('payslipID', $payslip->payslipID);
                                $this->db->where('premiumID', $erShares->premiumID);
                                $employerShare = $this->db->get('payslip_contributions')->row()->employerShare;
                                 
                                $info['er_'.$erShares->abbr] =  (!empty($employerShare)) ? $employerShare : 0;
                            }
                        }
                        
                        $data['records'][$group->$data['groupID']][] = $info;
                    }
                }
            }
            
            $this->db->where('companyID', $data['companyID']);
            $company = $this->db->get('companies', 1)->row();
                            
            $data['pdf_paging'] = TRUE;
            $data['title']      = "GENERAL PAYROLL";
            $data['modulename'] = "GENERAL PAYROLL";
            $data['subnote']    = $this->record->field->officeName;
            if (!empty($division)) {
                $data['subnote2']   = $this->record->field->divisionName;
                $data['subnote3']   = $this->record->field->payrollPeriod;
            } else {
                $data['subnote2']   = $this->record->field->payrollPeriod;
            }
    
            // load pdf class
            $this->load->library('mpdf');
            // load pdf class
            $this->mpdf->mpdf('en-GB',array(215.9,330.2),10,'Garamond',10,10,25,10,0,0,'L');
            $this->mpdf->setTitle($data['title']);
            $this->mpdf->SetDisplayMode('fullpage');
            $this->mpdf->shrink_tables_to_fit = 1;
            $this->mpdf->SetWatermarkImage(base_url().'images/logo/watermark.png');
            $this->mpdf->watermark_font = 'DejaVuSansCondensed';
            $this->mpdf->watermarkImageAlpha = 0.1;
            $this->mpdf->watermarkImgBehind = TRUE;
            $this->mpdf->showWatermarkImage = TRUE;
    
            // content
            $header = $this->load->view('print_pdf_header', $data, TRUE);
            $this->mpdf->SetHTMLHeader($header);
    
            $footer = $this->load->view('print_pdf_footer', $data, TRUE);
            $this->mpdf->SetHTMLFooter($footer);
    
            $html   = $this->load->view($this->module_path.'/print_sheet', $data, TRUE);
            $this->mpdf->WriteHTML($html);
    
            $this->mpdf->Output("GENERAL_PAYROLL.pdf","I");
//          $this->load->view($this->module_path.'/print_sheet', $data);
        } else {
            // no access this page
            $data['class']  = "danger";
            $data['msg']    = "Sorry, you don't have access to this page!";
            $data['urlredicrect']    = "";
            $this->load->view('header', $data);
            $this->load->view('message');
            $this->load->view('footer');
        }
    }

    public function print_notice_to_credit($payrollID = 0)
    {
        //************** general settings *******************
        // load submenu
        $this->submenu();
        $data = $this->data;
    
        $payrollID          = $this->encrypter->decode($payrollID);
        $data['title']      = "General Payroll";
        // **************************************************
    
        // check roles
        if ($this->roles['view']) {
            // for retrieve with joining tables -------------------------------------------------
            // set table
            $this->record->table = $this->table;
            // set fields for the current table
            $this->record->setFields();
            // extend fields - join tables
            $this->record->fields[] = 'payroll_periods.payrollPeriod';
            $this->record->fields[] = 'attendance_periods.payrollPeriod as attendancePeriod';
            $this->record->fields[] = 'payroll_periods.type';
            $this->record->fields[] = 'companies.companyName';
            $this->record->fields[] = 'offices.officeName';
            $this->record->fields[] = 'divisions.divisionName';
            $this->record->fields[] = 'payroll_groups.payrollGroup';
            
            // set joins
            $this->record->joins[]  = array('payroll_periods',$this->table.'.payrollPeriodID=payroll_periods.payrollPeriodID','left');
            $this->record->joins[]  = array('payroll_periods attendance_periods',$this->table.'.attendancePeriodID=attendance_periods.payrollPeriodID','left');
            $this->record->joins[]  = array('companies',$this->table.'.companyID=companies.companyID','left');
            $this->record->joins[]  = array('offices',$this->table.'.officeID=offices.officeID','left');
            $this->record->joins[]  = array('divisions',$this->table.'.divisionID=divisions.divisionID','left');
            $this->record->joins[]  = array('payroll_groups',$this->table.'.payrollGroupID=payroll_groups.payrollGroupID','left');
            // set where
            $this->record->where[$this->table.'.'.$this->pfield] = $payrollID;
                
            // execute retrieve
            $this->record->retrieve();
            // ----------------------------------------------------------------------------------
            $data['rec'] = $this->record->field;
            
            $this->db->select('payslips.*');
            $this->db->select('employments.employmentNo');
            $this->db->select('employees.fname');
            $this->db->select('employees.suffix');
            $this->db->select('employments.lname');
            $this->db->select('employments.mname');
            $this->db->select('employments.accountNo');
            $this->db->select('job_positions.positionCode');
            $this->db->select('job_titles.jobTitle');
            $this->db->from('payslips');
            $this->db->join('payroll','payslips.payrollID=payroll.payrollID', 'left');
            $this->db->join('employments','payslips.employmentID=employments.employmentID','left');
            $this->db->join('employees','employments.empID=employees.empID','left');
            $this->db->join('job_positions','employments.jobPositionID=job_positions.jobPositionID', 'left');
            $this->db->join('job_titles','job_positions.jobTitleID=job_titles.jobTitleID', 'left');
            $this->db->where('payslips.payrollID', $payrollID);
            //$this->db->where('payslips.status', 2);
            
            $data['records'] = $this->db->get();
            
            // analyze attendance
            $this->db->where('payrollPeriodID', $this->record->field->payrollPeriodID);
            $payroll = $this->db->get('payroll_periods', 1)->row();
            
            $start      = strtotime($payroll->startDate);
            $end        = strtotime($payroll->endDate);
            $data['log']= array();
                
            if ($data['records']->num_rows()) {
                foreach ($data['records']->result() as $row) {
                    $res['employmentNo'] = $row->employmentNo;
                    $res['employee']    = $row->lname.', '.$row->fname.', '.$row->mname.' '.$row->suffix;
                    $res['accountNo']   = $row->accountNo;
                    $res['netPay']      = $row->netPay;
                    
                    $data['log'][$row->employmentID] = $res;
                }
            }   
    
            $this->db->where('companyID', $this->record->field->companyID);
            $company = $this->db->get('companies', 1)->row();
    
            $this->db->where('officeID', $this->record->field->officeID);
            $office = $this->db->get('offices', 1)->row();
    
            $this->db->where('divisionID', $this->record->field->divisionID);
            $division = $this->db->get('divisions', 1)->row();
    
            $this->db->where('payrollPeriodID', $this->record->field->payrollPeriodID);
            $payroll = $this->db->get('payroll_periods', 1)->row();
    
            $data['pdf_paging'] = TRUE;
            $data['title']      = "NOTICE TO CREDIT";
            $data['modulename'] = "NOTICE TO CREDIT";
            $data['subnote']    = $office->officeName;
            if (!empty($division)) {
                $data['subnote2']   = $division->divisionName;
                $data['subnote3']   = $payroll->payrollPeriod;
            } else {
                $data['subnote2']   = $payroll->payrollPeriod;
            }
    
            // load pdf class
            $this->load->library('mpdf');
            // load pdf class
            $this->mpdf->mpdf('en-GB',array(215.9,330.2),10,'Garamond',10,10,25,10,0,0,'P');
            $this->mpdf->setTitle($data['title']);
            $this->mpdf->SetDisplayMode('fullpage');
            $this->mpdf->shrink_tables_to_fit = 1;
            $this->mpdf->SetWatermarkImage(base_url().'images/logo/watermark.png');
            $this->mpdf->watermark_font = 'DejaVuSansCondensed';
            $this->mpdf->watermarkImageAlpha = 0.1;
            $this->mpdf->watermarkImgBehind = TRUE;
            $this->mpdf->showWatermarkImage = TRUE;
    
            // content
            $header = $this->load->view('print_pdf_header', $data, TRUE);
            $this->mpdf->SetHTMLHeader($header);
    
            $footer = $this->load->view('print_pdf_footer', $data, TRUE);
            $this->mpdf->SetHTMLFooter($footer);
    
            $html   = $this->load->view('modules/Report/Payroll/print_notice_to_credit', $data, TRUE);
            $this->mpdf->WriteHTML($html);
    
            $this->mpdf->Output("NOTICE_TO_CREDIT.pdf","I");
        } else {
            // no access this page
            $data['class']  = "danger";
            $data['msg']    = "Sorry, you don't have access to this page!";
            $data['urlredicrect']    = "";
            $this->load->view('header', $data);
            $this->load->view('message');
            $this->load->view('footer');
        }
    }

    public function print_payslip($payrollID = 0)
    {
        //************** general settings *******************
        // load submenu
        $this->submenu();
        $data = $this->data;
    
        $payrollID          = $this->encrypter->decode($payrollID);
        $data['title']      = "Payslip";
        // **************************************************
    
        // check roles
        if ($this->roles['view']) {
            // for retrieve with joining tables -------------------------------------------------
            // set table
            $this->record->table = $this->table;
            // set fields for the current table
            $this->record->setFields();
            // extend fields - join tables      
            $this->record->fields[] = 'payroll_periods.payrollPeriod';
            $this->record->fields[] = 'attendance_periods.payrollPeriod as attendancePeriod';
            $this->record->fields[] = 'payroll_periods.type';
            $this->record->fields[] = 'companies.companyName';
            $this->record->fields[] = 'offices.officeName';
            $this->record->fields[] = 'offices.officeAbbr';
            $this->record->fields[] = 'divisions.divisionName'; 
            $this->record->fields[] = 'payroll_groups.payrollGroup';
                        
            // set joins
            $this->record->joins[]  = array('payroll_periods',$this->table.'.payrollPeriodID=payroll_periods.payrollPeriodID','left');
            $this->record->joins[]  = array('payroll_periods attendance_periods',$this->table.'.attendancePeriodID=attendance_periods.payrollPeriodID','left');
            $this->record->joins[]  = array('companies',$this->table.'.companyID=companies.companyID','left');
            $this->record->joins[]  = array('offices',$this->table.'.officeID=offices.officeID','left');
            $this->record->joins[]  = array('divisions',$this->table.'.divisionID=divisions.divisionID','left');                
            $this->record->joins[]  = array('payroll_groups',$this->table.'.payrollGroupID=payroll_groups.payrollGroupID','left');
            // set where
            $this->record->where[$this->table.'.'.$this->pfield] = $payrollID;
                
            // execute retrieve
            $this->record->retrieve();
            // ----------------------------------------------------------------------------------
            $data['rec'] = $this->record->field;
                
            $this->db->select('payslips.*');
            $this->db->select('employees.fname');
            $this->db->select('employees.suffix');
            $this->db->select('employments.lname');
            $this->db->select('employments.mname');
            $this->db->select('employments.employmentNo');                      
            $this->db->select('employee_types.employeeType');
            $this->db->select('job_titles.jobTitle');
            $this->db->from('payslips');
            $this->db->join('employees','payslips.empID=employees.empID','left');
            $this->db->join('employments','payslips.employmentID=employments.employmentID','left');
            $this->db->join('job_positions','employments.jobPositionID=job_positions.jobPositionID','left');
            $this->db->join('job_titles','job_positions.jobTitleID=job_titles.jobTitleID','left');
            $this->db->join('employee_types','payslips.employeeTypeID=employee_types.employeeTypeID','left');
            $this->db->where('payslips.payrollID', $payrollID);
            $payslips = $this->db->get();
            
            $this->db->select('incentive_types.*');
            $this->db->from('payslip_incentives');
            $this->db->join('payslips','payslip_incentives.payslipID=payslips.payslipID','left');
            $this->db->join('payroll','payslips.payrollID=payroll.payrollID','left');
            $this->db->join('incentive_types','payslip_incentives.incentiveTypeID=incentive_types.incentiveTypeID','left');
            $this->db->where('payslips.payrollID', $payrollID);
            $this->db->group_by('payslip_incentives.incentiveTypeID');
            $data['incentives'] = $this->db->get();
            
            $this->db->select('premiums.*');
            $this->db->from('payslip_contributions');
            $this->db->join('payslips','payslip_contributions.payslipID=payslips.payslipID','left');
            $this->db->join('payroll','payslips.payrollID=payroll.payrollID','left');
            $this->db->join('premiums','payslip_contributions.premiumID=premiums.premiumID','left');
            $this->db->where('payslips.payrollID', $payrollID);
            $this->db->where('payslip_contributions.employeeShare >', 0);
            $this->db->group_by('payslip_contributions.premiumID');
            $data['contributions'] = $this->db->get();
                
            $this->db->select('premiums.*');
            $this->db->from('payslip_contributions');
            $this->db->join('payslips','payslip_contributions.payslipID=payslips.payslipID','left');
            $this->db->join('payroll','payslips.payrollID=payroll.payrollID','left');
            $this->db->join('premiums','payslip_contributions.premiumID=premiums.premiumID','left');
            $this->db->where('payslips.payrollID', $payrollID);
            $this->db->where('payslip_contributions.employerShare >', 0);
            $this->db->group_by('payslip_contributions.premiumID');
            $data['erShares'] = $this->db->get();
                
            $this->db->select('loan_types.*');
            $this->db->from('payslip_deductions');
            $this->db->join('payslips','payslip_deductions.payslipID=payslips.payslipID','left');
            $this->db->join('payroll','payslips.payrollID=payroll.payrollID','left');
            $this->db->join('loan_types','payslip_deductions.deductionID=loan_types.loanTypeID','left');
            $this->db->where('payslips.payrollID', $payrollID);
            $this->db->where('payslip_deductions.type !=', 1);
            $this->db->group_by('payslip_deductions.deductionID');
            $data['deductions'] = $this->db->get();
    
            $this->db->where('companyID', $data['companyID']);
            $company = $this->db->get('companies', 1)->row();
                
            $data['pdf_paging'] = FALSE;
            $data['title']      = "PAYSLIP";
            $data['modulename'] = "PAYSLIP";
            $data['subnote']    = $this->record->field->officeName;
            if (!empty($division)) {
                $data['subnote2']   = $this->record->field->divisionName;
                $data['subnote3']   = $this->record->field->payrollPeriod;
            } else {
                $data['subnote2']   = $this->record->field->payrollPeriod;
            }
    
            // load pdf class
            $this->load->library('mpdf');
            // load pdf class
            $this->mpdf->mpdf('en-GB',array(210,140),10,'Garamond',5,5,5,5,0,0,'P');
            $this->mpdf->setTitle($data['title']);
            $this->mpdf->SetDisplayMode('fullpage');
            $this->mpdf->shrink_tables_to_fit = 1;
            $this->mpdf->SetWatermarkImage(base_url().'images/logo/watermark.png');
            $this->mpdf->watermark_font = 'DejaVuSansCondensed';
            $this->mpdf->watermarkImageAlpha = 0.1;
            $this->mpdf->watermarkImgBehind = TRUE;
            $this->mpdf->showWatermarkImage = TRUE;
    
            // content
//          $header = $this->load->view('print_pdf_header', $data, TRUE);
//          $this->mpdf->SetHTMLHeader($header);
    
//          $footer = $this->load->view('print_pdf_footer', $data, TRUE);
//          $this->mpdf->SetHTMLFooter($footer);
    
            if ($payslips->num_rows()) {
                foreach ($payslips->result() as $row) {
                    $data['payslip'] = $row;
                    
                    $html   = $this->load->view($this->module_path.'/print_payslip', $data, TRUE);
                    $this->mpdf->WriteHTML($html);
                }
            }
    
            $this->mpdf->Output("PAYSLIP.pdf","I");
        } else {
            // no access this page
            $data['class']  = "danger";
            $data['msg']    = "Sorry, you don't have access to this page!";
            $data['urlredicrect']    = "";
            $this->load->view('header', $data);
            $this->load->view('message');
            $this->load->view('footer');
        }
    }




    // Private functions
    private function _in_used($id=0)
    {
        $tables = array();
        
        if(!empty($tables)) {     
            foreach($tables as $table) {
                $this->db->where($this->pfield, $id);
                $result_count = $this->db->count_all_results($table);
                
                if($result_count > 0) {
                    return true;
                }
            }                               
        } 
        return false;
    }

    private function _generateID($series)
    {
        $idSeries   = $this->config_model->getConfig('General Payroll Series');
        $idLength   = $this->config_model->getConfig('General Payroll Series Length');
    
        $id  = str_pad($idSeries, $idLength, "0", STR_PAD_LEFT);
        return 'GNP'.$series.$id;
    }
}
